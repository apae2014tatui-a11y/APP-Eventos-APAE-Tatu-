
-- ======================================================
-- SCRIPT DE CONFIGURAÇÃO FINAL - APAE EVENTOS (V7)
-- RESOLUÇÃO DEFINITIVA DE CACHE (AUTORELOAD)
-- ======================================================

-- 1. LIMPEZA TOTAL COM CASCADE
DROP TABLE IF EXISTS public.sales CASCADE;
DROP TABLE IF EXISTS public.eventos CASCADE;
DROP TABLE IF EXISTS public.participantes CASCADE;

-- 2. RECRIAR TABELA DE EVENTOS
CREATE TABLE public.eventos (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    name text NOT NULL,
    date timestamptz NOT NULL,
    tickettypes jsonb DEFAULT '[]'::jsonb
);

-- 3. RECRIAR TABELA DE VENDAS
CREATE TABLE public.sales (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    eventid uuid REFERENCES public.eventos(id) ON DELETE CASCADE,
    customername text NOT NULL,
    customerphone text,
    paymentstatus text DEFAULT 'A pagar',
    paymentmethod text DEFAULT 'PIX',
    details text,
    ordernumber text,
    timestamp timestamptz DEFAULT now(),
    tickets jsonb DEFAULT '[]'::jsonb
);

-- 4. PERMISSÕES EXPLÍCITAS (ESSENCIAL)
GRANT USAGE ON SCHEMA public TO anon, authenticated, service_role;
GRANT ALL ON ALL TABLES IN SCHEMA public TO anon, authenticated, service_role;
GRANT ALL ON ALL SEQUENCES IN SCHEMA public TO anon, authenticated, service_role;
GRANT ALL ON ALL ROUTINES IN SCHEMA public TO anon, authenticated, service_role;

-- 5. POLÍTICAS DE SEGURANÇA (RLS)
ALTER TABLE public.eventos ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sales ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Anon Full Access Eventos" ON public.eventos FOR ALL TO anon USING (true) WITH CHECK (true);
CREATE POLICY "Anon Full Access Sales" ON public.sales FOR ALL TO anon USING (true) WITH CHECK (true);

-- 6. ATIVAÇÃO DE REALTIME
ALTER TABLE public.eventos REPLICA IDENTITY FULL;
ALTER TABLE public.sales REPLICA IDENTITY FULL;

-- 7. FORÇAR RELOAD DO SCHEMA CACHE (POSTGREST)
-- Este comando envia um sinal para o serviço de API do Supabase atualizar o mapa de tabelas
NOTIFY pgrst, 'reload schema';

-- 8. COMENTÁRIOS DE CONTROLE
COMMENT ON TABLE public.eventos IS 'V7 - Schema Refresh Signal Sent';
COMMENT ON TABLE public.sales IS 'V7 - Schema Refresh Signal Sent';

-- ======================================================
-- NOTA IMPORTANTE SOBRE A API KEY:
-- O erro "Could not find table" também ocorre se a 
-- SUPABASE_ANON_KEY no arquivo supabase.ts for inválida.
-- Certifique-se de que ela começa com "eyJ..." (JWT).
-- ======================================================
